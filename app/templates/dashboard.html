<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AI Bot Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #34495e;
      --accent-color: #3498db;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --light-color: #ecf0f1;
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    
    .navbar-custom {
      background-color: var(--primary-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .sidebar {
      background-color: white;
      min-height: calc(100vh - 56px);
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    
    .main-content {
      padding: 20px;
      background-color: #f8f9fa;
    }
    
    .card-custom {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.12);
    }
    
    .btn-primary-custom {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .btn-primary-custom:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    
    .api-key {
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }
    
    .table-custom th {
      background-color: var(--primary-color);
      color: white;
      border: none;
    }
    
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      background-color: #f8f9fa;
    }
    
    .user-message {
      background-color: var(--accent-color);
      color: white;
      border-radius: 18px 18px 0 18px;
      padding: 10px 15px;
      margin: 5px 0;
      max-width: 80%;
      margin-left: auto;
    }
    
    .bot-message {
      background-color: white;
      border: 1px solid #e9ecef;
      border-radius: 18px 18px 18px 0;
      padding: 10px 15px;
      margin: 5px 0;
      max-width: 80%;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-active {
      background-color: var(--success-color);
    }
    
    .welcome-header {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-robot me-2"></i>AI Bot Management
      </a>
      <div class="d-flex align-items-center">
        <span class="navbar-text me-3">
          Welcome, {{ session.username }}
        </span>
        <a href="/logout" class="btn btn-outline-light btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar p-3">
        <div class="d-flex flex-column">
          <button class="btn btn-primary-custom mb-3" data-bs-toggle="modal" data-bs-target="#createBotModal">
            <i class="fas fa-plus me-2"></i>Create New Bot
          </button>
          <button class="btn btn-outline-secondary mb-3" data-bs-toggle="modal" data-bs-target="#howToUseModal">
            <i class="fas fa-question-circle me-2"></i>How to Use
          </button>
          <button id="toggleDeleteMode" class="btn btn-outline-danger">
            <i class="fas fa-trash me-2"></i>Delete Bots
          </button>
          
          <hr class="my-4">
          
          <div class="mt-3">
            <h6 class="text-muted">Quick Links</h6>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link text-dark" href="/documentation"><i class="fas fa-book me-2"></i>Documentation</a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-dark" href="/support"><i class="fas fa-headset me-2"></i>Support</a>
              </li>

               <li class="nav-item">
                <a class="nav-link text-dark" href="/pricing" >
                  <i class="fas fa-crown me-2"></i>Upgrade Plans
                </a>
              </li>

            </ul>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 main-content">
        <div class="welcome-header">
          <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
          <p class="mb-0">Manage your AI bots and interactions</p>
        </div>

        <!-- Bots Section -->
        <div class="card card-custom mb-4">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0"><i class="fas fa-robot me-2"></i>Your Bots</h5>
          </div>
          <div class="card-body">
            {% if bots|length == 0 %}
              <div class="text-center py-4">
                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                <p class="text-muted">You have no bots yet. Create your first bot to get started.</p>
              </div>
            {% else %}
              <form id="deleteBotsForm" method="POST" action="/delete_bots">
                <div class="table-responsive">
                  <table class="table table-hover table-custom">
                    <thead>
                      <tr>
                        <th id="selectHeader" style="display:none;" width="50">
                          <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th width="60">#</th>
                        <th>Bot Name</th>
                        <th>Created At</th>
                        <th>API Key</th>
                        <th width="100">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for bot in bots %}
                      <tr>
                        <td class="selectCheckbox" style="display:none;">
                          <input type="checkbox" name="bot_ids" value="{{ bot.id }}" class="form-check-input">
                        </td>
                        <td>{{ loop.index }}</td>
                        <td>
                          <i class="fas fa-robot text-primary me-2"></i>
                          {{ bot.name }}
                        </td>
                        <td>{{ bot.created_at.strftime('%Y-%m-%d %H:%M') if bot.created_at else 'N/A' }}</td>
                        <td>
                          <code class="api-key">{{ bot.apikey }}</code>
                          <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ bot.apikey }}')">
                            <i class="fas fa-copy"></i>
                          </button>
                        </td>
                        <td>
                          <span class="status-indicator status-active"></span>
                          Active
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

                <div id="deleteSelectedWrapper" style="display:none;" class="mt-3">
                  <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash me-2"></i>Delete Selected Bots
                  </button>
                </div>
              </form>
            {% endif %}
          </div>
        </div>

        <!-- Test Chat Section -->
        {% if bots|length > 0 %}
        <div class="card card-custom">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-comments me-2"></i>Test Chat Interface</h5>
            <button type="button" class="btn btn-primary-custom btn-sm" data-bs-toggle="modal" data-bs-target="#chatModal">
              <i class="fas fa-comment me-1"></i>Open Chat
            </button>
          </div>
          <div class="card-body">
            <p class="text-muted">Use the chat interface to test your bots. Select a bot from the dropdown to interact with it.</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Create Bot Modal -->
  <div class="modal fade" id="createBotModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Create New Bot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" action="{{ url_for('main.create_bot') }}">
          <div class="modal-body">
            <div class="mb-3">
              <label for="botName" class="form-label">Bot Name</label>
              <input type="text" name="bot_name" class="form-control" id="botName" placeholder="Enter bot name" required>
            </div>
            <div class="mb-3">
              <label for="websiteUrl" class="form-label">Website URL</label>
              <input type="text" name="url" class="form-control" id="websiteUrl" placeholder="Enter website URL to scrape" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary-custom">Create Bot</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- How to Use Modal -->
  <div class="modal fade" id="howToUseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>How to Use</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>To integrate your bot into your website, copy and paste this script into your website's <code>&lt;body&gt;</code> section:</p>
          <div class="bg-light p-3 rounded mb-3">
            <pre class="mb-0"><code>&lt;script&gt;
  (function() {
    var botApiKey = "YOUR_API_KEY";
    var chatWidget = document.createElement("div");
    chatWidget.id = "my-chatbot";
    document.body.appendChild(chatWidget);

    var script = document.createElement("script");
    script.src = "https://yourdomain.com/static/js/chatbot.js?apikey=" + botApiKey;
    document.body.appendChild(script);
  })();
&lt;/script&gt;</code></pre>
          </div>
          <p>Replace <code>YOUR_API_KEY</code> with your actual bot's API key shown in the dashboard.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  {% if bots|length > 0 %}
  <div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-comments me-2"></i>Chat with Bot</h5>
          <div class="ms-auto me-3">
            <select id="botSelector" class="form-select form-select-sm">
              {% for bot in bots %}
              <option value="{{ bot.apikey }}">{{ bot.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="chatMessages" class="chat-messages"></div>
          <div class="input-group mt-3">
            <input type="text" id="userInput" class="form-control" placeholder="Type your message here...">
            <button type="button" id="sendMessage" class="btn btn-primary-custom">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Chat Button -->
  <button type="button" class="btn btn-primary-custom rounded-circle shadow"
          style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 999;"
          data-bs-toggle="modal" data-bs-target="#chatModal">
    <i class="fas fa-comments fa-lg"></i>
  </button>
  {% endif %}




  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Delete mode toggle
    document.getElementById('toggleDeleteMode').addEventListener('click', function() {
      const checkboxes = document.querySelectorAll('.selectCheckbox');
      const selectHeader = document.getElementById('selectHeader');
      const deleteSelectedWrapper = document.getElementById('deleteSelectedWrapper');
      const isHidden = checkboxes[0].style.display === 'none';

      checkboxes.forEach(cb => cb.style.display = isHidden ? 'table-cell' : 'none');
      selectHeader.style.display = isHidden ? 'table-cell' : 'none';
      deleteSelectedWrapper.style.display = isHidden ? 'block' : 'none';
      
      // Update button text
      this.innerHTML = isHidden ? 
        '<i class="fas fa-times me-2"></i>Cancel Delete' : 
        '<i class="fas fa-trash me-2"></i>Delete Bots';
    });

    // Select All functionality
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="bot_ids"]');
      checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        // Show some feedback that it was copied
        alert('API key copied to clipboard!');
      }, function(err) {
        console.error('Could not copy text: ', err);
      });
    }

    // Chat functionality (unchanged from original)
    let currentBotApiKey = document.getElementById('botSelector').value;
    let chatHistories = {};

    chatHistories[currentBotApiKey] = [];

    document.getElementById('botSelector').addEventListener('change', function() {
      const newBotApiKey = this.value;
      chatHistories[currentBotApiKey] = getCurrentChatMessages();
      currentBotApiKey = newBotApiKey;
      
      if (!chatHistories[currentBotApiKey]) {
        chatHistories[currentBotApiKey] = [];
      }
      
      refreshChatDisplay();
    });

    document.getElementById('sendMessage').addEventListener('click', sendMessage);
    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    function getCurrentChatMessages() {
      const chatMessages = document.getElementById('chatMessages');
      const messages = [];
      const messageElements = chatMessages.querySelectorAll('div');
      
      messageElements.forEach(element => {
        messages.push({
          html: element.outerHTML,
          isUser: element.classList.contains('user-message')
        });
      });
      
      return messages;
    }

    function refreshChatDisplay() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      chatHistories[currentBotApiKey].forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = message.html;
        chatMessages.appendChild(messageDiv);
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();

      if (!message) {
        alert("Please enter a message.");
        return;
      }

      const chatMessages = document.getElementById('chatMessages');
      const userMessage = document.createElement('div');
      userMessage.className = 'user-message';
      userMessage.innerHTML = `<strong>You:</strong> ${message}`;
      chatMessages.appendChild(userMessage);
      
      chatHistories[currentBotApiKey].push({
        html: userMessage.outerHTML,
        isUser: true
      });

      userInput.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'bot-message text-muted';
      typingIndicator.id = 'typingIndicator';
      typingIndicator.innerHTML = `<strong>Bot:</strong> Thinking...`;
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;


      fetch('/api/dashboard_chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          query: message,
          api_key: currentBotApiKey
        })
      })
      .then(response => response.json())
      .then(data => {
        const typingElement = document.getElementById('typingIndicator');
        if (typingElement) {
          typingElement.remove();
        }

        const botMessage = document.createElement('div');
        botMessage.className = 'bot-message';
        
        if (data.response) {
          botMessage.innerHTML = `<strong>Bot:</strong> ${data.response}`;
        } else if (data.error) {
          botMessage.innerHTML = `<strong>Error:</strong> ${data.error}`;
        } else {
          botMessage.innerHTML = `<strong>Bot:</strong> Sorry, I couldn't process that request.`;
        }
        
        chatMessages.appendChild(botMessage);
        
        chatHistories[currentBotApiKey].push({
          html: botMessage.outerHTML,
          isUser: false
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      })
      .catch(error => {
        console.error('Error sending message:', error);
        
        const typingElement = document.getElementById('typingIndicator');
        if (typingElement) {
          typingElement.remove();
        }
        
        const errorMessage = document.createElement('div');
        errorMessage.className = 'bot-message text-danger';
        errorMessage.innerHTML = `<strong>Error:</strong> Failed to send message. Please try again.`;
        chatMessages.appendChild(errorMessage);
        
        chatHistories[currentBotApiKey].push({
          html: errorMessage.outerHTML,
          isUser: false
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    // Initialize chat display
    refreshChatDisplay();
  </script>
</body>
</html>