<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2>Welcome {{ session.username }}</h2>

  <p>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBotModal">‚ûï Create Bot</button>
    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#howToUseModal">‚ÑπÔ∏è How to Use</button>
    <button id="toggleDeleteMode" class="btn btn-danger">üóëÔ∏è Delete Bots</button>
  </p>

  <!-- Modal for Creating Bot -->
  <div class="modal fade" id="createBotModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{{ url_for('main.create_bot') }}">
          <div class="modal-header">
            <h5 class="modal-title">Create New Bot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" name="bot_name" class="form-control mb-2" placeholder="Bot Name" required>
            <input type="text" name="url" class="form-control" placeholder="Website URL to scrape" required>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Create Bot</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- How to Use Modal -->
  <div class="modal fade" id="howToUseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">How to Use</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Copy this script into your website‚Äôs &lt;body&gt; section:</p>
          <pre>&lt;script&gt;
            (function() {
                  var botApiKey = "YOUR_API_KEY";
                  var chatWidget = document.createElement("div");
                  chatWidget.id = "my-chatbot";
                  document.body.appendChild(chatWidget);

                  var script = document.createElement("script");
                  script.src = "https://yourdomain.com/static/js/chatbot.js?apikey=" + botApiKey;
                  document.body.appendChild(script);
                })();
            &lt;/script&gt;
          </pre>
              <p>Replace <code>YOUR_API_KEY</code> with your actual bot‚Äôs API key shown in the dashboard below.</p>
        </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
      </div>
    </div>
  </div>

  <!-- Bots Table -->
  <h3>Your Bots:</h3>
  {% if bots|length == 0 %}
    <p>You have no bots yet. Create one to get started!</p>
  {% else %}
    

    {% if bots|length > 0 %}
      <!-- Floating Chat Icon -->
      <button type="button" class="btn btn-primary rounded-circle"
              style="position: fixed; bottom: 20px; right: 20px; z-index: 999;"
              data-bs-toggle="modal" data-bs-target="#chatModal">
        üí¨
      </button>

  
      <!-- Chat Modal -->
      <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Chat with Bot</h5>

              <!-- Bot Selector Dropdown -->
              <select id="botSelector" class="form-select w-auto ms-3">
                {% for bot in bots %}
                <option value="{{ bot.apikey }}">{{ bot.name }}</option>
                {% endfor %}
              </select>

              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
              <input type="text" id="userInput" class="form-control mt-2" placeholder="Type your message here...">
            </div>

            <div class="modal-footer">
              <button type="button" id="sendMessage" class="btn btn-primary">Send</button>
              

            </div>
          </div>
        </div>
      </div>

    {% endif %}


  <form id="deleteBotsForm" method="POST" action="/delete_bots">
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th id="selectHeader" style="display:none;"><input type="checkbox" id="selectAll"></th>
          <th>#</th>
          <th>Bot Name</th>
          <th>Created At</th>
          <th>API Key</th>
        </tr>
      </thead>
      <tbody>
        {% for bot in bots %}
        <tr>
          <td class="selectCheckbox" style="display:none;">
            <input type="checkbox" name="bot_ids" value="{{ bot.id }}">
          </td>
          <td>{{ loop.index }}</td>
          <td>{{ bot.name }}</td>
          <td>{{ bot.created_at.strftime('%Y-%m-%d %H:%M') if bot.created_at else 'N/A' }}</td>
          <td><code>{{ bot.apikey }}</code></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div id="deleteSelectedWrapper" style="display:none;">
      <button type="submit" class="btn btn-danger">Delete Selected</button>
    </div>
  </form>

  <script>
    document.getElementById('toggleDeleteMode').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.selectCheckbox');
    const selectHeader = document.getElementById('selectHeader');
    const deleteSelectedWrapper = document.getElementById('deleteSelectedWrapper');
    const isHidden = checkboxes[0].style.display === 'none';

    checkboxes.forEach(cb => cb.style.display = isHidden ? 'table-cell' : 'none');
    selectHeader.style.display = isHidden ? 'table-cell' : 'none';
    deleteSelectedWrapper.style.display = isHidden ? 'block' : 'none';
        });

    // Select All functionality
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="bot_ids"]');
      checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });
  </script>
  {% endif %}
  
 
  <p class="mt-4">Need help? Visit our <a href="#">documentation</a> or <a href="/support">contact support</a>.</p>



  <p class="mt-3"><a href="/logout">Logout</a></p>

</div>
<script>
  let currentBotApiKey = document.getElementById('botSelector').value;
  let chatHistories = {}; // Store chat history per bot

  // Initialize with first bot's history
  chatHistories[currentBotApiKey] = [];

  // Bot selector change event - CLEARS CHAT WHEN SWITCHING BOTS
  document.getElementById('botSelector').addEventListener('change', function() {
    const newBotApiKey = this.value;
    
    // Save current chat history (optional - remove if you don't want to save)
    chatHistories[currentBotApiKey] = getCurrentChatMessages();
    
    // Switch to new bot
    currentBotApiKey = newBotApiKey;
    
    // Load new bot's chat history (or initialize empty)
    if (!chatHistories[currentBotApiKey]) {
      chatHistories[currentBotApiKey] = [];
    }
    
    // Refresh chat display - THIS CLEARS AND SHOWS NEW BOT'S CHAT
    refreshChatDisplay();
  });

  // Send message function
  document.getElementById('sendMessage').addEventListener('click', sendMessage);

  // Allow Enter key to send message
  document.getElementById('userInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  function getCurrentChatMessages() {
    const chatMessages = document.getElementById('chatMessages');
    const messages = [];
    const messageElements = chatMessages.querySelectorAll('div');
    
    messageElements.forEach(element => {
      messages.push({
        html: element.outerHTML,
        isUser: element.classList.contains('text-end')
      });
    });
    
    return messages;
  }

  function refreshChatDisplay() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = ''; // Clear current display
    
    // Load messages for current bot
    chatHistories[currentBotApiKey].forEach(message => {
      const messageDiv = document.createElement('div');
      messageDiv.innerHTML = message.html;
      chatMessages.appendChild(messageDiv);
    });
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();

    if (!message) {
      alert("Please enter a message.");
      return;
    }

    // Display user's message immediately
    const chatMessages = document.getElementById('chatMessages');
    const userMessage = document.createElement('div');
    userMessage.className = 'text-end mb-2 text-primary';
    userMessage.innerHTML = `<strong>You:</strong> ${message}`;
    chatMessages.appendChild(userMessage);
    
    // Add to current bot's history
    chatHistories[currentBotApiKey].push({
      html: userMessage.outerHTML,
      isUser: true
    });

    // Clear input and scroll
    userInput.value = '';
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'text-start mb-2 text-muted';
    typingIndicator.id = 'typingIndicator';
    typingIndicator.innerHTML = `<strong>Bot:</strong> Thinking...`;
    chatMessages.appendChild(typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Send to backend
    fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        query: message,
        api_key: currentBotApiKey
      })
    })
    .then(response => response.json())
    .then(data => {
      // Remove typing indicator
      const typingElement = document.getElementById('typingIndicator');
      if (typingElement) {
        typingElement.remove();
      }

      // Display bot response
      const botMessage = document.createElement('div');
      botMessage.className = 'text-start mb-2 text-success';
      
      if (data.response) {
        botMessage.innerHTML = `<strong>Bot:</strong> ${data.response}`;
      } else if (data.error) {
        botMessage.innerHTML = `<strong>Error:</strong> ${data.error}`;
      } else {
        botMessage.innerHTML = `<strong>Bot:</strong> Sorry, I couldn't process that request.`;
      }
      
      chatMessages.appendChild(botMessage);
      
      // Add to current bot's history
      chatHistories[currentBotApiKey].push({
        html: botMessage.outerHTML,
        isUser: false
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
      console.error('Error sending message:', error);
      
      // Remove typing indicator
      const typingElement = document.getElementById('typingIndicator');
      if (typingElement) {
        typingElement.remove();
      }
      
      const errorMessage = document.createElement('div');
      errorMessage.className = 'text-start text-danger mb-2';
      errorMessage.innerHTML = `<strong>Error:</strong> Failed to send message. Please try again.`;
      chatMessages.appendChild(errorMessage);
      
      chatHistories[currentBotApiKey].push({
        html: errorMessage.outerHTML,
        isUser: false
      });
      
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  // Initialize chat display
  refreshChatDisplay();
</script>
</body>
</html>
